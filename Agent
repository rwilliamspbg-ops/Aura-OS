import 'dotenv/config'; 
import { PrismaClient } from './prisma/generated/index.js'; 
import pkg from 'pg'; 
const { Pool } = pkg; 
import { PrismaPg } from '@prisma/adapter-pg'; 
import fs from 'fs'; 
import path from 'path'; 

// Database Setup
const connectionString = process.env.DATABASE_URL;
const pool = new Pool({ connectionString });
const adapter = new PrismaPg(pool);
const prisma = new PrismaClient({ adapter });

// Logging Setup
const logPath = path.join(process.cwd(), 'restock.log');

function logFriction(message: string) {
  const timestamp = new Date().toISOString();
  const logEntry = `[${timestamp}] ${message}\n`;
  
  // Append to restock.log (creates it if it doesn't exist)
  fs.appendFileSync(logPath, logEntry);
}

async function monitorInventoryFriction() {
  console.log('üîç AURA OS: Scanning inventory for friction...');
  
  try {
    const lowStockItems = await prisma.inventoryItem.findMany({
      where: {
        // Triggers if stock is at or below 10 (or your specific par level logic)
        currentStock: { lte: 10 } 
      },
      include: { location: true }
    });

    if (lowStockItems.length === 0) {
      console.log('‚úÖ All stock levels nominal.');
      return;
    }

    lowStockItems.forEach(item => {
      const alertMsg = `FRICTION ALERT: ${item.name} at ${item.location?.name} is low (${item.currentStock} ${item.unit} remaining).`;
      
      // Print to Terminal
      console.log(`\x1b[31m[ALERT]\x1b[0m ${alertMsg}`);
      
      // Write to restock.log
      logFriction(alertMsg);
    });
  } catch (error) {
    console.error('‚ùå Agent Error:', error);
  }
}

// Execution Loop
monitorInventoryFriction();
setInterval(monitorInventoryFriction, 60000);

